<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>BON - Utang Warung</title>
  <style>
    /* --- SAMA SEPERTI SEBELUMNYA --- */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #e0f7fa, #f3e5f5, #e8f5e9);
      padding: 12px;
      min-height: 100vh;
      color: #1a237e;
      font-size: 16px;
      line-height: 1.4;
    }

    @media (min-width: 769px) {
      body {
        font-size: 22px;
      }
    }

    .container {
      max-width: 100%;
      width: 100%;
      margin: auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      border: 3px solid #81d4fa;
    }

    header {
      background: linear-gradient(90deg, #4fc3f7, #81c784, #ba68c8);
      color: white;
      text-align: center;
      padding: 16px 12px;
      font-weight: 900;      font-size: 2.0em;      letter-spacing: 1px;      text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
      line-height: 1.2;
    }

    @media (min-width: 769px) {
      header {
        font-size: 2.4em;
        padding: 20px 16px;
      }
    }

    .main-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
      background: #f9fbfd;
    }

    @media (min-width: 769px) {
      .main-content {
        padding: 24px;
      }
    }

    h2 {
      margin: 16px 0 12px;
      color: #0288d1;
      font-size: 1.4em;
      font-weight: 800;
    }
    h3 {
      margin: 12px 0 8px;
      color: #388e3c;
      font-size: 1.3em;
      font-weight: 700;
    }

    @media (min-width: 769px) {
      h2 { font-size: 1.6em; margin: 20px 0 16px; }
      h3 { font-size: 1.5em; margin: 16px 0 12px; }
    }

    label {
      display: block;
      margin-top: 14px;
      font-weight: 700;
      color: #5e35b1;
      font-size: 16px;    }
    @media (min-width: 769px) {      label {
        font-size: 20px;      }
    }

    input, button {
      width: 100%;
      padding: 12px;
      margin-top: 6px;
      margin-bottom: 14px;
      border: 2px solid #90caf9;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      background: #ffffff;
    }

    @media (min-width: 769px) {
      input, button {
        padding: 16px;
        font-size: 20px;
        margin-top: 10px;
        margin-bottom: 18px;
        border-radius: 12px;
      }
    }

    input:focus {
      outline: none;
      border-color: #29b6f6;
      box-shadow: 0 0 0 3px rgba(41, 182, 246, 0.3);
    }

    button {
      border: none;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.25s ease;
    }

    button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 12px rgba(0,0,0,0.18);
    }

    .btn-bon {
      background: linear-gradient(to right, #a5d6a7, #81c784);
      color: #1b5e20;    }
    #simpanBonBtn {
      background: linear-gradient(to right, #4fc3f7, #29b6f6);      color: white;
      font-size: 17px;
      padding: 14px;    }

    @media (min-width: 769px) {
      #simpanBonBtn {
        font-size: 22px;
        padding: 18px;
      }
    }

    .pelanggan-item {
      background: #f3f9ff;
      padding: 16px;
      margin: 12px 0;
      border-radius: 14px;
      border-left: 6px solid #ba68c8;
      box-shadow: 0 3px 10px rgba(186, 104, 200, 0.1);
      position: relative;
    }

    @media (min-width: 769px) {
      .pelanggan-item {
        padding: 20px;
        margin: 16px 0;
        border-radius: 16px;
      }
    }

    .edit-nama-btn {
      background: #7b1fa2;
      color: white;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      font-size: 14px;
      cursor: pointer;
      position: absolute;
      top: 12px;
      right: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (min-width: 769px) {      .edit-nama-btn {
        width: 40px;
        height: 40px;
        font-size: 18px;        top: 16px;
        right: 16px;
      }
    }
    .modal {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.65);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 18px;
      width: 92%;
      max-width: 380px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      border: 3px solid #90caf9;
      font-size: 16px;
    }

    @media (min-width: 769px) {
      .modal-content {
        font-size: 20px;
        padding: 24px;
        max-width: 450px;
      }
    }

    .hidden { display: none; }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 14px;
      flex-wrap: wrap;
    }
    @media (min-width: 769px) {
      .action-buttons {
        gap: 14px;        margin-top: 18px;
      }
    }
    .btn-bayar,
    .btn-salin,    .btn-hapus,
    .btn-bon-baru,
    .btn-share {
      padding: 10px;
      border-radius: 8px;      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: bold;
      flex: 1;
      min-width: 80px;
    }

    @media (min-width: 769px) {
      .btn-bayar,
      .btn-salin,
      .btn-hapus,
      .btn-bon-baru,
      .btn-share {
        padding: 14px;
        font-size: 18px;
        border-radius: 10px;
        min-width: 100px;
      }
    }

    .btn-bayar { background: linear-gradient(to right, #4fc3f7, #29b6f6); color: white; }
    .btn-salin { background: linear-gradient(to right, #fff59d, #ffeb3b); color: #5d4037; }
    .btn-hapus { background: linear-gradient(to right, #f48fb1, #f06292); color: white; }
    .btn-bon-baru { background: linear-gradient(to right, #a5d6a7, #81c784); color: #1b5e20; }
    .btn-share { background: linear-gradient(to right, #ffcc80, #ffb74d); color: #5d4037; }

    #cariPelanggan {
      margin-top: 10px;
      margin-bottom: 14px;
      border-color: #90caf9;
      font-size: 16px;
      padding: 12px;
    }
    @media (min-width: 769px) {
      #cariPelanggan {
        font-size: 20px;
        padding: 14px;
      }
    }    .bon-barang-list {
      margin-top: 12px;
      padding: 12px;
      background: #e1f5fe;
      border-radius: 10px;
      border-left: 4px solid #29b6f6;    }

    .bon-barang-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;      font-size: 15px;
      align-items: center;
      font-weight: 600;
    }

    @media (min-width: 769px) {
      .bon-barang-item {
        font-size: 18px;
        padding: 10px 0;
      }
    }

    .hapus-barang-btn {
      background: #f06292;
      color: white;
      border: none;
      border-radius: 6px;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-left: 8px;
    }

    @media (min-width: 769px) {
      .hapus-barang-btn {
        width: 34px;
        height: 34px;
        font-size: 16px;
        margin-left: 12px;
      }
    }
    .timestamp {
      font-size: 13px;
      color: #455a64;      font-style: italic;
      margin-top: 6px;
      display: block;
    }
    .bon-timestamp {
      background: #e1f5fe;
      padding: 6px 10px;      border-radius: 6px;
      margin-top: 8px;
      font-weight: 700;
      color: #0288d1;
      border-left: 3px solid #29b6f6;
      font-size: 13px;
    }
    @media (min-width: 769px) {
      .timestamp, .bon-timestamp {
        font-size: 16px;
      }
    }

    .backup-section {
      background: #f3e5f5;
      padding: 18px;
      border-radius: 14px;
      margin: 20px 0;
      border: 3px dashed #ba68c8;
      text-align: center;
    }

    @media (min-width: 769px) {
      .backup-section {
        padding: 24px;
        margin: 28px 0;
        border-width: 4px;
      }
    }

    .backup-section h2 {
      margin-bottom: 12px;
      font-size: 1.4em;
      color: #6a1b9a;
    }

    @media (min-width: 769px) {
      .backup-section h2 {
        font-size: 1.7em;
        margin-bottom: 16px;
      }
    }
    .backup-buttons {
      display: flex;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .backup-btn {
      padding: 12px 16px;
      border-radius: 10px;
      border: none;
      font-weight: bold;
      cursor: pointer;
      font-size: 15px;
      flex: 1;      min-width: 140px;
    }

    @media (min-width: 769px) {
      .backup-btn {
        padding: 16px 24px;
        font-size: 18px;
        min-width: 180px;
      }
    }

    .btn-backup {
      background: linear-gradient(to right, #ce93d8, #ba68c8);
      color: white;
    }

    .backup-note {
      margin-top: 12px;
      font-size: 13px;
      color: #6a1b9a;
      line-height: 1.4;
    }
    @media (min-width: 769px) {
      .backup-note {
        font-size: 16px;
        margin-top: 16px;
      }
    }
    .share-modal {
      background: white;
      padding: 20px;
      border-radius: 18px;
      width: 92%;
      max-width: 380px;      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      border: 3px solid #ffb74d;
      font-size: 16px;
      position: relative;
    }
    @media (min-width: 769px) {
      .share-modal {
        font-size: 20px;
        padding: 24px;        max-width: 450px;
      }
    }
    .share-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }
    @media (min-width: 769px) {
      .share-options {
        gap: 16px;
        margin-top: 20px;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
    }

    .share-option {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 12px;
      border-radius: 10px;
      background: #fffde7;
      border: 2px solid #ffd54f;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    @media (min-width: 769px) {
      .share-option {
        padding: 16px;
        border-radius: 12px;
      }
    }
    .share-option:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      background: #ffecb3;    }
    .share-icon {
      font-size: 24px;
      margin-bottom: 6px;
    }

    @media (min-width: 769px) {
      .share-icon {
        font-size: 32px;
        margin-bottom: 8px;      }
    }

    .share-label {
      font-size: 13px;
      font-weight: 600;
      text-align: center;
    }

    @media (min-width: 769px) {      .share-label {
        font-size: 16px;
      }
    }

    .close-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f44336;
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      font-size: 18px;
    }

    @media (min-width: 769px) {
      .close-btn {
        width: 36px;
        height: 36px;
        font-size: 22px;
        top: 16px;
        right: 16px;
      }    }
    .highlight-info {
      font-weight: bold;
      font-size: 1.5em;
      margin: 8px 0;
      color: #0288d1;
    }

    @media (min-width: 769px) {
      .highlight-info {
        font-size: 2em;      }
    }

    .salin-semua-btn {
      background: linear-gradient(to right, #80cbc4, #26a69a);
      color: white;
      margin-top: 10px;
    }

    .salin-semua-btn:hover {
      background: linear-gradient(to right, #26a69a, #00897b);    }

    .status-lunas {
      color: #388e3c !important;
      font-weight: bold;
    }

    /* Autocomplete */
    .autocomplete-container {
      position: relative;
      width: 100%;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #90caf9;
      border-top: none;
      border-radius: 0 0 10px 10px;
      z-index: 100;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .autocomplete-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s;
    }
    .autocomplete-item:hover {
      background: #e3f2fd;
    }

    .autocomplete-item:last-child {
      border-bottom: none;    }

    .autocomplete-highlight {
      background: #bbdefb;
      font-weight: bold;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;      transform: translateX(-50%);
      background: #4caf50;
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      z-index: 2000;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>BON</header>

    <div class="main-content">      
      <h2>üìù Buat Bon Baru</h2>
      <label>Nama Pelanggan:</label>
      <div class="autocomplete-container">
        <input type="text" id="namaPelanggan" maxlength="100" placeholder="Siapa yang nge-bon?" oninput="showAutocomplete('pelanggan')" onfocus="showAutocomplete('pelanggan')">
        <div id="autocompleteListPelanggan" class="autocomplete-list hidden"></div>
      </div>
      <label>Nama Barang:</label>
      <div class="autocomplete-container">
        <input type="text" id="namaBarangManual" maxlength="100" placeholder="Contoh: Rokok Sampoerna" oninput="showAutocomplete('barang')" onfocus="showAutocomplete('barang')">
        <div id="autocompleteListBarang" class="autocomplete-list hidden"></div>      </div>

      <!-- üî∏ DIPERBARUI: HAPUS max pada input harga -->
      <label>Harga (Rp):</label>
      <input type="number" id="hargaBarangManual" min="0" placeholder="Contoh: 25000">

      <!-- üî∏ DIPERBARUI: HAPUS max pada input jumlah -->
      <label>Jumlah:</label>
      <input type="number" id="jumlahBarangManual" min="1" value="1" placeholder="Contoh: 2">

      <button class="btn-bon" onclick="tambahBarangKeBon()">‚ûï Tambah ke Bon</button>

      <h3>üõí Barang di Bon Ini:</h3>
      <div id="keranjangBon">Kosong</div>      <button id="simpanBonBtn" onclick="simpanBonBaru()">üíæ Simpan Bon</button>

      <h2>üë• Nama Pelanggan (Total Utang)</h2>
      
      <div style="background:#e3f2fd;padding:10px;border-radius:8px;margin:12px 0;font-weight:bold;color:#0288d1;">
        üì¶ Jumlah Barang: <span id="jumlahBarang">0</span>
      </div>
      
      <input type="text" id="cariPelanggan" maxlength="100" placeholder="Cari nama pelanggan..." oninput="debouncedFilterPelanggan()">
      <div id="daftarPelanggan">Belum ada yang ngebon.</div>

      <div class="backup-section">        <h2>üì• Backup Data</h2>
        <div class="backup-buttons">
          <button class="backup-btn btn-backup" onclick="eksporKeJson()">
            üíæ Ekspor ke JSON
          </button>
          <button class="backup-btn btn-backup" onclick="simpanKeGoogleDrive()" style="background:linear-gradient(to right, #4285F4, #34A853);color:white;">
            ‚òÅÔ∏è Simpan ke Google Drive
          </button>
          <label class="backup-btn btn-backup" style="cursor:pointer;background:linear-gradient(to right, #ffab91, #ff8a65);color:white;padding:12px 16px;border-radius:10px;min-width:140px;display:inline-block;">
            üì§ Impor JSON
            <input type="file" id="imporJson" accept=".json" onchange="imporData(this.files[0])" style="display:none;">
          </label>
        </div>
        <p class="backup-note">
          ‚Ä¢ Klik "Ekspor ke JSON" untuk unduh file<br>
          ‚Ä¢ Klik "Simpan ke Google Drive" ‚Üí file akan dibuat ‚Üí seret ke Google Drive Anda!<br>
          ‚Ä¢ Pastikan Anda sudah login ke Google
        </p>
      </div>
    </div>
  </div>

  <div id="modalEditNama" class="hidden modal">    <div class="modal-content">
      <h3 style="margin-bottom:16px;color:#5e35b1;font-weight:800;text-align:center;">‚úèÔ∏è Edit Nama Pelanggan</h3>
      <input type="text" id="inputNamaBaru" maxlength="100" placeholder="Nama baru" style="width:100%;padding:12px;border:2px solid #90caf9;border-radius:10px;margin-bottom:14px;">
      <input type="hidden" id="namaLama">
      <div style="display:flex;gap:12px;justify-content:center;">
        <button class="btn-bon" style="flex:1;padding:12px;" onclick="simpanEditNama()">‚úîÔ∏è Simpan</button>
        <button style="background:linear-gradient(to right, #f48fb1, #f06292);color:white;flex:1;padding:12px;border:none;border-radius:10px;" onclick="tutupModal('modalEditNama')">‚ùå Batal</button>
      </div>
    </div>
  </div>

  <div id="shareModal" class="hidden modal">
    <div class="share-modal">
      <div class="close-btn" onclick="tutupModal('shareModal')">‚úï</div>      <h3 style="margin-bottom:16px;color:#ef6c00;font-weight:800;text-align:center;">üì§ Bagikan Ringkasan</h3>
      <p style="text-align:center;margin-bottom:16px;">Pilih cara berbagi:</p>
      <div class="share-options">
        <div class="share-option" onclick="bagikanVia('whatsapp')">
          <div class="share-icon">üí¨</div>
          <div class="share-label">WhatsApp</div>
        </div>
        <div class="share-option" onclick="bagikanVia('email')">
          <div class="share-icon">‚úâÔ∏è</div>
          <div class="share-label">Email</div>
        </div>
        <div class="share-option" onclick="bagikanVia('sms')">
          <div class="share-icon">üì±</div>
          <div class="share-label">SMS</div>
        </div>        <div class="share-option" onclick="bagikanVia('lainnya')">
          <div class="share-icon">üîó</div>
          <div class="share-label">Lainnya</div>
        </div>
      </div>
      <input type="hidden" id="shareNamaPelanggan">
    </div>
  </div>

  <script>
    // === UTILITIES ===
    function safeString(str, maxlength = 100) {
      if (str == null) return '';
      let clean = String(str)
        .replace(/\r\n/g, ' ')
        .replace(/\n/g, ' ')
        .replace(/\t/g, ' ')
        .trim()
        .substring(0, maxlength);
      const map = { '&': '&', '<': '<', '>': '>', '"': '"', "'": '&#x27;' };
      return clean.replace(/[&<>"']/g, s => map[s]);    }

    function showToast(message, isError = false) {
      const existing = document.querySelector('.toast');
      if (existing) existing.remove();

      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message.substring(0, 200);
      toast.style.background = isError ? '#f44336' : '#4caf50';
      document.body.appendChild(toast);
      setTimeout(() => {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 3000);
    }
    let filterTimeout;
    function debouncedFilterPelanggan() {
      clearTimeout(filterTimeout);
      filterTimeout = setTimeout(filterPelanggan, 300);
    }

    // === DATA STORAGE ===
    let semuaBon = [];
    let pembayaran = [];
    let keranjang = [];
    const MAX_DATA_SIZE = 5 * 1024 * 1024;

    function safeParseJSON(str) {
      try {
        return JSON.parse(str);      } catch {
        return null;
      }
    }

    function loadData() {
      try {
        const storedBon = localStorage.getItem('semuaBon');
        const storedBayar = localStorage.getItem('pembayaran');

        const bonParsed = safeParseJSON(storedBon);
        const bayarParsed = safeParseJSON(storedBayar);

        semuaBon = Array.isArray(bonParsed) ? bonParsed : [];
        pembayaran = Array.isArray(bayarParsed) ? bayarParsed : [];

        semuaBon = semuaBon.filter(bon => isValidBon(bon));
        pembayaran = pembayaran.filter(p => isValidPembayaran(p));
      } catch (e) {        console.warn("Reset data karena error:", e);
        semuaBon = [];
        pembayaran = [];
      }
    }

    function isValidBon(bon) {
      return bon &&
        typeof bon.namaPelanggan === 'string' &&
        bon.namaPelanggan.trim().length > 0 &&
        typeof bon.total === 'number' &&
        bon.total >= 0 &&
        // üî∏ TIDAK ADA BATAS ATAS TOTAL
        Array.isArray(bon.items) &&
        typeof bon.waktu === 'string';
    }
    function isValidPembayaran(p) {
      return p &&
        typeof p.namaPelanggan === 'string' &&
        p.namaPelanggan.trim().length > 0 &&
        typeof p.jumlah === 'number' &&
        p.jumlah > 0 &&
        // üî∏ TIDAK ADA BATAS ATAS PEMBAYARAN
        typeof p.waktu === 'string';
    }

    function simpanKeStorage() {
      try {
        const bonStr = JSON.stringify(semuaBon);
        const bayarStr = JSON.stringify(pembayaran);

        if (new Blob([bonStr, bayarStr]).size > MAX_DATA_SIZE) {          showToast("‚ö†Ô∏è Data terlalu besar. Hapus beberapa entri.", true);
          return false;
        }

        localStorage.setItem('semuaBon', bonStr);
        localStorage.setItem('pembayaran', bayarStr);
        return true;
      } catch (e) {
        console.error("Gagal simpan ke localStorage:", e);
        showToast("‚ùå Gagal menyimpan data. Penyimpanan penuh?", true);
        return false;
      }
    }

    // === TOGGLE BARANG ===
    const HIDDEN_BARANG_KEY = 'hiddenBarangMap';
    let hiddenBarangMap = {};
    function loadHiddenBarangMap() {
      try {
        const saved = localStorage.getItem(HIDDEN_BARANG_KEY);
        const parsed = safeParseJSON(saved);
        hiddenBarangMap = parsed && typeof parsed === 'object' ? parsed : {};
      } catch (e) {
        hiddenBarangMap = {};
      }
    }

    function saveHiddenBarangMap() {
      try {
        localStorage.setItem(HIDDEN_BARANG_KEY, JSON.stringify(hiddenBarangMap));
      } catch (e) {
        // silent fail
      }    }

    // ‚úÖ DIPERBARUI: Default SEMBUNYIKAN barang
    function getBarangVisible(namaPelanggan) {
      if (!namaPelanggan) return false;
      const key = namaPelanggan.toLowerCase();
      return hiddenBarangMap[key] === false;
    }

    // ‚úÖ DIPERBARUI: Toggle logic yang konsisten
    function toggleBarang(namaPelanggan) {
      if (!namaPelanggan) return;
      const key = namaPelanggan.toLowerCase();
      const currentlyVisible = getBarangVisible(namaPelanggan);
      hiddenBarangMap[key] = currentlyVisible; // true = sembunyikan, false = tampilkan
      saveHiddenBarangMap();
      renderDaftarPelanggan();
    }
    function getFullTimestamp() {
      return new Date().toLocaleString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).replace('pukul ', 'pukul ');
    }

    // === EKSPOR KE JSON ===
    function eksporKeJson() {
      try {
        const data = {
          semuaBon,
          pembayaran,          versi: "BON-v1"
        };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `bon-utang-warung-${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast("‚úÖ File JSON berhasil diunduh!");
      } catch (e) {        showToast("‚ùå Gagal ekspor JSON.", true);
      }
    }

    // === SIMPAN KE GOOGLE DRIVE (MANUAL) ===
    function simpanKeGoogleDrive() {
      try {
        const data = {
          semuaBon,
          pembayaran,
          versi: "BON-v1"
        };
        const jsonStr = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        // Buat link download
        const a = document.createElement('a');
        a.href = url;        a.download = `bon-utang-warung-${new Date().toISOString().slice(0,10)}.json`;
        a.style.display = 'none';
        document.body.appendChild(a);
        a.click();
        
        // Buka Google Drive di tab baru
        window.open('https://drive.google.com/drive/my-drive', '_blank');
        
        // Bersihkan
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showToast("‚úÖ File dibuat! Seret ke Google Drive.");
      } catch (e) {
        showToast("‚ùå Gagal membuat file.", true);
      }
    }
    // === IMPOR DATA ===
    function imporData(file) {
      if (!file || file.size > MAX_DATA_SIZE) {
        showToast("‚ùå File terlalu besar (>5MB).", true);
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = safeParseJSON(e.target.result);
          if (!data || typeof data !== 'object') {
            throw new Error("JSON tidak valid");
          }
          if (!Array.isArray(data.semuaBon) || !Array.isArray(data.pembayaran)) {
            throw new Error("Format tidak sesuai");
          }

          const validBon = data.semuaBon.filter(isValidBon);
          const validBayar = data.pembayaran.filter(isValidPembayaran);

          if (validBon.length === 0 && validBayar.length === 0) {
            showToast("‚ùå Tidak ada data valid untuk diimpor.", true);
            return;
          }

          semuaBon = validBon;
          pembayaran = validBayar;

          if (simpanKeStorage()) {
            renderDaftarPelanggan();
            showToast("‚úÖ Data berhasil diimpor!");
          }
          document.getElementById('imporJson').value = '';
        } catch (err) {
          console.error("Error impor:", err);
          showToast("‚ùå File tidak valid atau rusak.", true);
          document.getElementById('imporJson').value = '';
        }
      };
      reader.onerror = () => {
        showToast("‚ùå Gagal membaca file.", true);
        document.getElementById('imporJson').value = '';
      };
      reader.readAsText(file);
    }
    // === KERANJANG ===
    function tambahBarangKeBon() {
      let nama = document.getElementById('namaBarangManual').value.trim();
      let hargaStr = document.getElementById('hargaBarangManual').value.trim();
      let qtyStr = document.getElementById('jumlahBarangManual').value.trim();

      if (!nama) {
        showToast("‚ùó Nama barang tidak boleh kosong!", true);
        return;
      }
      if (!hargaStr) {
        showToast("‚ùó Harga tidak boleh kosong!", true);
        return;
      }
      if (!qtyStr) {
        showToast("‚ùó Jumlah tidak boleh kosong!", true);        return;
      }

      nama = safeString(nama, 100);
      const harga = Number(hargaStr);
      const qty = Math.floor(Number(qtyStr));

      if (isNaN(harga) || harga < 0) {
        showToast("‚ùó Harga harus ‚â• 0!", true);
        return;
      }
      if (isNaN(qty) || qty < 1) {
        showToast("‚ùó Jumlah harus ‚â• 1!", true);
        return;
      }

      const existing = keranjang.find(item =>
        item.nama === nama && item.hargaSaatIni === harga
      );

      if (existing) {        existing.qty += qty;
      } else {
        keranjang.push({ nama, hargaSaatIni: harga, qty });
      }

      renderKeranjangBon();
      document.getElementById('namaBarangManual').value = '';
      document.getElementById('hargaBarangManual').value = '';
      document.getElementById('jumlahBarangManual').value = '1';
      hideAutocomplete('barang');
    }

    function hapusBarangDariBon(index) {      if (index >= 0 && index < keranjang.length) {
        keranjang.splice(index, 1);
        renderKeranjangBon();
      }
    }

    function renderKeranjangBon() {
      const div = document.getElementById('keranjangBon');
      if (keranjang.length === 0) {
        div.innerHTML = 'üõí Kosong';
        return;
      }
      let html = '<div class="bon-barang-list">';
      keranjang.forEach((item, index) => {
        if (!item || typeof item.nama !== 'string' || typeof item.hargaSaatIni !== 'number' || typeof item.qty !== 'number') return;
        const qty = Math.max(item.qty, 1); // minimal 1
        const subtotal = item.hargaSaatIni * qty;        html += `
          <div class="bon-barang-item">
            <span>${safeString(item.nama)} (x${qty})</span>
            <div style="display:flex;align-items:center;">
              <span>Rp ${subtotal.toLocaleString('id-ID')}</span>
              <button class="hapus-barang-btn" onclick="hapusBarangDariBon(${index})">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      div.innerHTML = html;
    }

    function simpanBonBaru() {
      let nama = document.getElementById('namaPelanggan').value.trim();
      if (!nama) {
        showToast("‚ùó Masukkan nama pelanggan!", true);
        return;
      }
      if (keranjang.length === 0) {
        showToast("‚ùó Bon masih kosong!", true);        return;
      }

      nama = safeString(nama, 100);
      if (nama.length === 0) {
        showToast("‚ùó Nama tidak valid!", true);
        return;
      }

      const items = keranjang.map(item => ({
        nama: safeString(item.nama),        hargaSaatItu: Math.max(0, item.hargaSaatIni),
        qty: Math.max(item.qty || 1, 1),
        subtotal: (item.hargaSaatIni || 0) * (item.qty || 1)
      }));

      const total = items.reduce((s, i) => s + (i.subtotal || 0), 0);
      const bonBaru = {
        namaPelanggan: nama,
        total,
        items,
        waktu: getFullTimestamp()
      };

      semuaBon.push(bonBaru);
      if (simpanKeStorage()) {
        renderDaftarPelanggan();
        keranjang = [];
        document.getElementById('namaPelanggan').value = '';        renderKeranjangBon();
        hideAutocomplete('pelanggan');
      }
    }

    // === EDIT NAMA, PEMBAYARAN, DLL ===
    function bukaEditNama(namaLama) {
      if (!namaLama) return;
      document.getElementById('inputNamaBaru').value = namaLama;
      document.getElementById('namaLama').value = namaLama;
      document.getElementById('modalEditNama').classList.remove('hidden');
    }

    function simpanEditNama() {
      const namaLama = document.getElementById('namaLama').value;
      let namaBaru = document.getElementById('inputNamaBaru').value.trim();

      if (!namaBaru) {
        showToast("‚ùó Nama tidak boleh kosong!", true);
        return;
      }
      if (namaBaru.toLowerCase() === namaLama.toLowerCase()) {
        tutupModal('modalEditNama');        return;
      }

      namaBaru = safeString(namaBaru, 100);
      if (namaBaru.length === 0) {
        showToast("‚ùó Nama tidak valid!", true);
        return;
      }
      const lowerBaru = namaBaru.toLowerCase();
      const exists = semuaBon.some(bon =>
        bon && typeof bon.namaPelanggan === 'string' &&
        bon.namaPelanggan.toLowerCase() === lowerBaru
      ) || pembayaran.some(p =>
        p && typeof p.namaPelanggan === 'string' &&
        p.namaPelanggan.toLowerCase() === lowerBaru
      );

      if (exists) {
        showToast("‚ùó Nama tersebut sudah ada!", true);
        return;
      }

      const lowerLama = namaLama.toLowerCase();
      semuaBon = semuaBon.map(bon => {
        if (bon && typeof bon.namaPelanggan === 'string' &&
            bon.namaPelanggan.toLowerCase() === lowerLama) {
          return { ...bon, namaPelanggan: namaBaru };        }
        return bon;
      });
      pembayaran = pembayaran.map(p => {
        if (p && typeof p.namaPelanggan === 'string' &&
            p.namaPelanggan.toLowerCase() === lowerLama) {
          return { ...p, namaPelanggan: namaBaru };
        }
        return p;
      });

      if (simpanKeStorage()) {
        if (hiddenBarangMap[lowerLama] !== undefined) {
          hiddenBarangMap[lowerBaru] = hiddenBarangMap[lowerLama];
          delete hiddenBarangMap[lowerLama];
          saveHiddenBarangMap();
        }
        renderDaftarPelanggan();
        tutupModal('modalEditNama');
      }
    }

    function bayarUtang(namaPelanggan) {
      if (!namaPelanggan) return;      const nominal = prompt(`üí∞ Bayar berapa untuk ${namaPelanggan}?`);
      if (nominal === null) return;
      const jumlah = Number(nominal);
      if (isNaN(jumlah) || jumlah <= 0) {
        showToast("‚ùó Nominal harus > 0!", true);
        return;
      }
      pembayaran.push({
        namaPelanggan: safeString(namaPelanggan),
        jumlah,
        waktu: getFullTimestamp()
      });

      if (simpanKeStorage()) {
        renderDaftarPelanggan();
      }
    }

    function hapusPelanggan(namaPelanggan) {
      if (!namaPelanggan) return;
      if (!confirm(`‚ö†Ô∏è Hapus SEMUA data "${namaPelanggan}"?`)) return;
      const key = namaPelanggan.toLowerCase();
      semuaBon = semuaBon.filter(bon =>
        bon && typeof bon.namaPelanggan === 'string' &&
        bon.namaPelanggan.toLowerCase() !== key
      );      pembayaran = pembayaran.filter(p =>
        p && typeof p.namaPelanggan === 'string' &&
        p.namaPelanggan.toLowerCase() !== key
      );
      delete hiddenBarangMap[key];
      saveHiddenBarangMap();
      if (simpanKeStorage()) {
        renderDaftarPelanggan();
      }
    }

    function buatBonBaruDariNama(namaPelanggan) {
      if (!namaPelanggan) return;
      document.getElementById('namaPelanggan').value = namaPelanggan;
      document.querySelector('.main-content').scrollIntoView({ behavior: 'smooth' });
      hideAutocomplete('pelanggan');
    }

    // === BAGIKAN & SALIN ===
    function generateRingkasanTeks(namaPelanggan) {
      if (!namaPelanggan) return null;
      const lower = namaPelanggan.toLowerCase();
      const bonList = semuaBon.filter(bon =>
        bon && typeof bon.namaPelanggan === 'string' &&
        bon.namaPelanggan.toLowerCase() === lower      );
      const bayarList = pembayaran.filter(p =>
        p && typeof p.namaPelanggan === 'string' &&
        p.namaPelanggan.toLowerCase() === lower
      );      if (bonList.length === 0) return null;

      const totalUtang = bonList.reduce((sum, bon) => sum + (typeof bon.total === 'number' ? bon.total : 0), 0);
      const totalBayar = bayarList.reduce((sum, p) => sum + (typeof p.jumlah === 'number' ? p.jumlah : 0), 0);
      const sisaUtang = totalUtang - totalBayar;
      const lunas = sisaUtang <= 0;

      const lines = [];
      lines.push(`üìò Ringkasan Utang: ${safeString(namaPelanggan)}`);
      lines.push("");
      lines.push(`Total Utang: Rp ${totalUtang.toLocaleString('id-ID')}`);
      lines.push(`Total Dibayar: Rp ${totalBayar.toLocaleString('id-ID')}`);
      lines.push(`Sisa Utang: Rp ${Math.max(0, sisaUtang).toLocaleString('id-ID')}`);
      if (lunas) {
        if (sisaUtang < 0) {
          lines.push(`‚úÖ LUNAS (Kembalian: Rp ${(-sisaUtang).toLocaleString('id-ID')})`);
        } else {
          lines.push(`‚úÖ LUNAS`);
        }
      }
      lines.push("");
      if (bonList.length > 0) {
        lines.push('üìã DAFTAR BON:');
        bonList.forEach((bon, idx) => {
          lines.push("");
          lines.push(`Bon #${idx + 1} (Total: Rp ${bon.total.toLocaleString('id-ID')})`);
          if (Array.isArray(bon.items)) {
            bon.items.forEach(item => {
              if (item && typeof item.nama === 'string') {
                const qty = (typeof item.qty === 'number' && item.qty > 0) ? item.qty : 1;
                const subtotal = typeof item.subtotal === 'number' ? item.subtotal :
                                (typeof item.hargaSaatItu === 'number' ? item.hargaSaatItu * qty : 0);
                lines.push(`‚Ä¢ ${safeString(item.nama)} (x${qty}) = Rp ${subtotal.toLocaleString('id-ID')}`);
              }
            });
          }
          lines.push(`üìÖ ${bon.waktu || 'Waktu tidak tersedia'}`);
        });
      }
      if (bayarList.length > 0) {
        lines.push("");
        lines.push('üí∞ RIWAYAT PEMBAYARAN:');
        bayarList.forEach(p => {
          lines.push(`‚Ä¢ Bayar Rp ${p.jumlah.toLocaleString('id-ID')} (${p.waktu || 'Waktu tidak tersedia'})`);
        });
      }
      lines.push("");
      lines.push("‚Äî Dicatat via BON ‚Äî");      return lines.join('\n');
    }

    function bukaBagikan(namaPelanggan) {
      if (!namaPelanggan) return;
      document.getElementById('shareNamaPelanggan').value = namaPelanggan;
      document.getElementById('shareModal').classList.remove('hidden');
    }

    function bagikanVia(metode) {
      const namaPelanggan = document.getElementById('shareNamaPelanggan').value;
      const text = generateRingkasanTeks(namaPelanggan);
      if (!text) {
        showToast("‚ùå Tidak ada data.", true);
        return;
      }
      const subject = `Ringkasan Utang: ${namaPelanggan}`;
      const encodedText = encodeURIComponent(text.substring(0, 4000));
      switch(metode) {
        case 'whatsapp':
          window.open(`https://wa.me/?text=${encodedText}`, '_blank');
          break;        case 'email':
          window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodedText}`, '_blank');
          break;
        case 'sms':
          window.open(`sms:?body=${encodedText}`, '_blank');
          break;
        case 'lainnya':
          if (navigator.share) {
            navigator.share({ title: subject, text: text.substring(0, 10000) })
              .catch(() => fallbackPrompt(text));
          } else {
            fallbackPrompt(text);
          }
          break;
      }
      tutupModal('shareModal');
    }

    function fallbackPrompt(text) {
      const result = prompt("‚úÖ Salin teks berikut (tekan & tahan ‚Üí Salin):", text.substring(0, 2000));
      if (result === null) return;
      showToast("üí° Teks siap ditempel di aplikasi lain.");
    }

    function salinSemua(namaPelanggan) {
      if (!namaPelanggan) {
        showToast("‚ùå Nama tidak valid.", true);        return;      }
      const lower = namaPelanggan.toLowerCase();
      const bonList = semuaBon.filter(bon =>
        bon && typeof bon.namaPelanggan === 'string' &&
        bon.namaPelanggan.toLowerCase() === lower
      );
      const bayarList = pembayaran.filter(p =>
        p && typeof p.namaPelanggan === 'string' &&
        p.namaPelanggan.toLowerCase() === lower
      );
      if (bonList.length === 0) {
        showToast("‚ùå Tidak ada data untuk disalin.", true);
        return;
      }

      const totalUtang = bonList.reduce((sum, bon) => sum + (typeof bon.total === 'number' ? bon.total : 0), 0);
      const totalBayar = bayarList.reduce((sum, p) => sum + (typeof p.jumlah === 'number' ? p.jumlah : 0), 0);
      const sisaUtang = totalUtang - totalBayar;
      const kembalian = sisaUtang < 0 ? -sisaUtang : 0;
      const lines = [];
      lines.push(`nama : ${safeString(namaPelanggan)}`);
      lines.push(`Total Utang: Rp ${totalUtang.toLocaleString('id-ID')}`);
      lines.push(`Sudah Dibayar: Rp ${totalBayar.toLocaleString('id-ID')}`);      lines.push(`Sisa Utang: Rp ${Math.max(0, sisaUtang).toLocaleString('id-ID')}`);
      if (kembalian > 0) {
        lines.push(`Kembalian: Rp ${kembalian.toLocaleString('id-ID')}`);
      }
      lines.push(`Detail Barang:`);
      bonList.forEach(bon => {
        if (Array.isArray(bon.items)) {
          bon.items.forEach(item => {
            if (item && typeof item.nama === 'string') {
              const qty = (typeof item.qty === 'number' && item.qty > 0) ? item.qty : 1;
              const subtotal = typeof item.subtotal === 'number' ? item.subtotal :
                              (typeof item.hargaSaatItu === 'number' ? item.hargaSaatItu * qty : 0);
              lines.push(`${safeString(item.nama)} (x${qty}) = Rp ${subtotal.toLocaleString('id-ID')}`);
            }
          });
        }
      });

      const text = lines.join('\n').substring(0, 10000);
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text).then(() => {
          showToast("‚úÖ Teks disalin ke clipboard!");
        }).catch(() => fallbackCopyText(text));
      } else {
        fallbackCopyText(text);
      }
    }
    function fallbackCopyText(text) {      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.top = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      try {
        const success = document.execCommand('copy');
        if (success) {
          showToast("‚úÖ Teks disalin ke clipboard!");
        } else {
          throw new Error('Gagal');
        }
      } catch (err) {
        showToast("‚ö†Ô∏è Salin manual: tekan & tahan teks di atas.", true);
      }
      document.body.removeChild(textarea);
    }

    // === AUTOCOMPLETE ===
    function showAutocomplete(type) {
      const inputId = type === 'pelanggan' ? 'namaPelanggan' : 'namaBarangManual';      const listId = type === 'pelanggan' ? 'autocompleteListPelanggan' : 'autocompleteListBarang';
      const input = document.getElementById(inputId);
      const query = input.value.trim().toLowerCase();
      const autocompleteList = document.getElementById(listId);
      if (!autocompleteList) return;
      autocompleteList.innerHTML = '';

      if (query.length === 0 || query.length > 50) {
        autocompleteList.classList.add('hidden');
        return;
      }

      const seen = new Set();
      const uniqueItems = [];

      if (type === 'pelanggan') {
        semuaBon.forEach(bon => {
          if (bon && typeof bon.namaPelanggan === 'string') {
            const clean = bon.namaPelanggan.trim();
            if (clean && clean.length <= 100 && !seen.has(clean.toLowerCase())) {
              seen.add(clean.toLowerCase());
              uniqueItems.push(clean);
            }
          }
        });
      } else {        semuaBon.forEach(bon => {
          if (bon && Array.isArray(bon.items)) {
            bon.items.forEach(item => {
              if (item && typeof item.nama === 'string') {                const clean = item.nama.trim();
                if (clean && clean.length <= 100 && !seen.has(clean.toLowerCase())) {
                  seen.add(clean.toLowerCase());
                  uniqueItems.push(clean);
                }
              }
            });
          }
        });
      }

      const filteredItems = uniqueItems
        .filter(name => name.toLowerCase().includes(query))
        .sort();
      if (filteredItems.length === 0) {
        autocompleteList.classList.add('hidden');
        return;
      }

      filteredItems.forEach(name => {
        const item = document.createElement('div');        item.className = 'autocomplete-item';
        const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
        const highlightedName = name.replace(regex, '<span class="autocomplete-highlight">$1</span>');
        item.innerHTML = highlightedName;
        item.addEventListener('click', () => {
          input.value = name;
          autocompleteList.classList.add('hidden');
          input.focus();
          if (type === 'barang') {
            fillHargaBarang(name);
          }
        });

        autocompleteList.appendChild(item);
      });

      autocompleteList.classList.remove('hidden');
    }

    function hideAutocomplete(type) {
      const listId = type === 'pelanggan' ? 'autocompleteListPelanggan' : 'autocompleteListBarang';
      const el = document.getElementById(listId);
      if (el) el.classList.add('hidden');
    }
    function fillHargaBarang(namaBarang) {
      if (!namaBarang) return;
      let hargaTerakhir = 0;
      for (let i = semuaBon.length - 1; i >= 0; i--) {
        const bon = semuaBon[i];
        if (bon && Array.isArray(bon.items)) {          for (let j = bon.items.length - 1; j >= 0; j--) {
            const item = bon.items[j];
            if (item && item.nama === namaBarang && typeof item.hargaSaatItu === 'number') {
              hargaTerakhir = item.hargaSaatItu;
              break;
            }
          }
          if (hargaTerakhir > 0) break;
        }
      }
      if (hargaTerakhir > 0) {
        document.getElementById('hargaBarangManual').value = hargaTerakhir;
      }
    }

    document.addEventListener('click', (e) => {
      const containers = document.querySelectorAll('.autocomplete-container');
      let clickedInside = false;
      containers.forEach(container => {
        if (container.contains(e.target)) {          clickedInside = true;
        }
      });
      if (!clickedInside) {
        hideAutocomplete('pelanggan');
        hideAutocomplete('barang');
      }
    });

    // === RENDER ===
    function filterPelanggan() {
      renderDaftarPelanggan();
    }

    function renderDaftarPelanggan() {
      const div = document.getElementById('daftarPelanggan');
      const query = document.getElementById('cariPelanggan').value.trim().toLowerCase();

      const validBon = semuaBon.filter(isValidBon);
      if (validBon.length === 0) {
        div.innerHTML = 'üë• Belum ada yang ngebon.';
        document.getElementById('jumlahBarang').textContent = '0';
        return;
      }
      // üîπ HITUNG JUMLAH BARANG TOTAL üîπ
      let totalQty = 0;
      validBon.forEach(bon => {
        if (Array.isArray(bon.items)) {
          bon.items.forEach(item => {
            if (item && typeof item.qty === 'number') {
              totalQty += item.qty;            }
          });
        }
      });
      document.getElementById('jumlahBarang').textContent = totalQty;

      const pelangganMap = {};
      validBon.forEach(bon => {
        const key = bon.namaPelanggan.toLowerCase();
        if (!pelangganMap[key]) {
          pelangganMap[key] = {
            namaAsli: bon.namaPelanggan,
            totalUtang: 0,
            bonList: []
          };
        }
        pelangganMap[key].totalUtang += bon.total;
        pelangganMap[key].bonList.push(bon);
      });
      const totalBayar = {};
      pembayaran.filter(isValidPembayaran).forEach(p => {
        const key = p.namaPelanggan.toLowerCase();
        totalBayar[key] = (totalBayar[key] || 0) + p.jumlah;
      });

      const filteredPelanggan = Object.values(pelangganMap).filter(p =>
        p.namaAsli.toLowerCase().includes(query)
      );

      if (filteredPelanggan.length === 0) {
        div.innerHTML = 'üîç Tidak ditemukan.';
        return;
      }

      let html = '';
      filteredPelanggan.forEach(p => {
        const key = p.namaAsli.toLowerCase();
        const totalDibayar = totalBayar[key] || 0;
        const sisaUtang = p.totalUtang - totalDibayar;
        const lunas = sisaUtang <= 0;
        let statusText = '';
        if (lunas) {
          const kembalian = totalDibayar - p.totalUtang;
          if (kembalian > 0) {
            statusText = `<span class="status-lunas">‚úÖ LUNAS (Kembalian: Rp ${kembalian.toLocaleString('id-ID')})</span>`;
          } else {
            statusText = '<span class="status-lunas">‚úÖ LUNAS</span>';
          }
        }
        let content = `
          <strong>Nama: ${safeString(p.namaAsli)}</strong>
          <button class="edit-nama-btn" onclick='bukaEditNama("${p.namaAsli.replace(/"/g, '"')}")'>‚úèÔ∏è</button><br>
          Total Utang: Rp ${p.totalUtang.toLocaleString('id-ID')}<br>
          Sudah Dibayar: Rp ${totalDibayar.toLocaleString('id-ID')}<br>
          <strong>Sisa Utang: Rp ${Math.max(0, sisaUtang).toLocaleString('id-ID')}</strong> ${statusText}<br><br>
        `;
        if (getBarangVisible(p.namaAsli)) {
          p.bonList.forEach((bon, idx) => {
            let itemsList = '';
            if (Array.isArray(bon.items)) {
              const validItems = bon.items.filter(item =>
                item && typeof item.nama === 'string' && typeof item.hargaSaatItu === 'number'
              );
              itemsList = validItems.map(item => {
                const qty = (typeof item.qty === 'number' && item.qty > 0) ? item.qty : 1;
                const subtotal = typeof item.subtotal === 'number' ? item.subtotal :
                                (typeof item.hargaSaatItu === 'number' ? item.hargaSaatItu * qty : 0);                return `‚Ä¢ ${safeString(item.nama)} (x${qty}) = Rp ${subtotal.toLocaleString('id-ID')}`;
              }).join('<br>');
            }
            if (itemsList) {
              content += `
                <div style="margin-top:12px; padding-top:10px; border-top:1px dashed #aaa; font-size:15px;">
                  <strong>Bon #${idx + 1} (Total: Rp ${bon.total.toLocaleString('id-ID')})</strong><br>
                  ${itemsList}
                  <div class="bon-timestamp">üìÖ ${bon.waktu || 'Waktu tidak tersedia'}</div>
                </div>
              `;
            }
          });
        }

        const riwayatBayar = pembayaran
          .filter(pay => pay && pay.namaPelanggan.toLowerCase() === key)
          .map(pb => `<div class="timestamp">üí∞ Bayar: Rp ${pb.jumlah.toLocaleString('id-ID')} (${pb.waktu || 'Waktu tidak tersedia'})</div>`)
          .join('');
        if (riwayatBayar) {
          content += `<br><strong>Riwayat Pembayaran:</strong><br>${riwayatBayar}`;
        }
        html += `
          <div class="pelanggan-item" style="${lunas ? 'border-left-color:#81c784;background:#e8f5e9;' : ''}">
            ${content}
            <div class="action-buttons">
              <button class="btn-bon-baru" onclick='buatBonBaruDariNama("${p.namaAsli.replace(/"/g, '"')}")'>üìÑ Bon Baru</button>
              <button class="btn-bayar" onclick='bayarUtang("${p.namaAsli.replace(/"/g, '"')}")'>üí∞ Bayar</button>
              <button class="btn-hapus" onclick='hapusPelanggan("${p.namaAsli.replace(/"/g, '"')}")'>üóëÔ∏è Hapus</button>
              <button class="btn-share" onclick='bukaBagikan("${p.namaAsli.replace(/"/g, '"')}")'>üì§ Bagikan</button>
              <button class="btn-salin salin-semua-btn" onclick='salinSemua("${p.namaAsli.replace(/"/g, '"')}")'>üìã Salin Semua</button>
              <button class="btn-salin" onclick='toggleBarang("${p.namaAsli.replace(/"/g, '"')}")'>
                üëÅÔ∏è ${getBarangVisible(p.namaAsli) ? 'Sembunyikan' : 'Tampilkan'} Barang              </button>
            </div>
          </div>
        `;
      });
      div.innerHTML = html;
    }

    function tutupModal(id) {
      const el = document.getElementById(id);
      if (el) el.classList.add('hidden');
    }
    
    // === INIT ===
    loadData();
    loadHiddenBarangMap();
    renderDaftarPelanggan();  </script>
</body>
</html>
